create or replace PACKAGE BODY pk_ext_duelistcom AS

    FUNCTION ap_ext_duelistcom (
        cursname IN OUT pk_ext_duelistcom.cursname
    ) RETURN NUMBER AS

        var_l_dat_process              DATE;
        var_l_session_id               NUMBER := 0;
        var_ctr_instal                 ln_acct_schedule.ctr_instal%TYPE := 0;
        var_l_ctr_instal_null          NUMBER(38, 2) := 0;
        var_ctr_received_instal        FLOAT := 0;
        var_dat_last_payment           ln_arrears_table.dat_last_payment%TYPE := NULL;
        var_l_decimal_arrears_left_due NUMBER(38, 1) := 0.0;
        var_l_amt_diff                 ln_arrears_table.amt_arrears_assessed%TYPE := 0;
        var_l_amt_arrears_due          ln_arrears_table.amt_arrears_due%TYPE := 0;
        var_l_amt_assessed_cal         ln_arrears_table.amt_arrears_assessed%TYPE := 0;
        var_nam_cust_spouse            ci_custmast_ext.txt_spouse_name%TYPE := NULL;
        var_ctr_instal_ioi             ln_acct_schedule.ctr_instal%TYPE := 0;
        var_ctr_instal_epi_emi         ln_acct_schedule.ctr_instal%TYPE := 0;
        var_l_overdue_interest         ln_arrears_table.amt_arrears_due%TYPE := 0;
        var_l_overdue_prin             ln_arrears_table.amt_arrears_due%TYPE := 0;
        var_l_ctr_instal_null_greater  FLOAT := 0.0;
        var_net_effect_rat             ln_acct_state.rat_int_current%TYPE := 0;
        var_total_due                  ln_arrears_table.amt_arrears_due%TYPE := 0;
        var_dat_next_due               VARCHAR2(20) := NULL;
        var_l_amt_arrears_due_assessed ln_arrears_table.amt_arrears_due%TYPE := 0;
        var_ctr_overdue_instal         ln_arrears_table.amt_arrears_due%TYPE := 0;
        var_l_arrears_count            ln_arrears_table.amt_arrears_due%TYPE := 0;
        var_total_due_1                ln_arrears_table.amt_arrears_due%TYPE := NULL;   
        VAR_L_LAST_RECEIPT_AMOUNT      ln_nobook_ext.AMT_TXN_ACY%TYPE := NULL;  
        CURSOR cursor_duelistcom IS
        SELECT
            ln.cod_acct_no,
            ln.nam_cust_shrt,
            ln.cod_cc_brn,
            ln.amt_face_value, -- LOAN_AMOUNT
            ln.dat_first_disb, -- BOOKING_DATE
            ln.cod_prod,
            ln.cod_cust_id,
            CASE
                WHEN amt_disbursed >= amt_face_value THEN
                    'F'
                ELSE
                    'P'
            END                                                                      disb_status,
            ctr_term_months, --TOTAL_NO_OF_INSTL
            ctr_curr_term_months, --TOTAL_NO_OF_INSTL
             --NET_RATE,
            amt_princ_balance, --TOTAL_POS
            amt_arrears_princ, -- OVERDUE_PRIN
            ( accbal.amt_arrears_susp_regular_int + accbal.amt_arrears_regular_int ) overdue_interest, -- OVERDUE_INTEREST
            ctr_instal,
            cod_acct_stat,
            replace(brnmast.nam_branch, ',', '')                                     nam_branch, --BRANCH
            nam_cc_city, --REGION
            nam_cc_state, --STATE,
            ln.dat_of_maturity                                                       dat_of_maturity_d
        FROM
            ln_acct_dtls     ln,
            ln_acct_balances accbal,
            ba_cc_brn_mast   brnmast
        WHERE
                accbal.cod_acct_no = ln.cod_acct_no
            AND brnmast.cod_cc_brn = ln.cod_cc_brn
            AND brnmast.flg_mnt_status = 'A'
            AND ln.flg_mnt_status = 'A'
            AND ln.ctr_disb > 0
            AND cod_acct_stat NOT IN ( 1, 5, 11 );

    BEGIN
        BEGIN
            SELECT
                dat_process
            INTO var_l_dat_process
            FROM
                ba_bank_mast
            WHERE
                flg_mnt_status = 'A';

        EXCEPTION
            WHEN OTHERS THEN
                ora_raiserror(sqlcode, 'select failed in ba_bank_mast', $$plsql_line);
                RETURN 100;
        END;

        BEGIN
            var_l_session_id := userenv('SESSIONID');
        END;
        BEGIN
            DELETE FROM temp_ln_x_duelistcom_ext
            WHERE
                session_id = var_l_session_id;

        END;
        BEGIN
            FOR rec IN cursor_duelistcom LOOP
                var_ctr_received_instal := 0.0;
                var_dat_last_payment := NULL;
                var_l_amt_diff := 0.0;
                var_l_amt_arrears_due := 0;
                var_l_amt_assessed_cal := 0.0;
                var_l_decimal_arrears_left_due := 0.0;
                var_l_ctr_instal_null := 0;
                var_l_ctr_instal_null_greater := 0.0;
                BEGIN
                    SELECT
                        ctr_term_months
                    INTO var_ctr_instal
                    FROM
                        ln_acct_dtls
                    WHERE
                            cod_acct_no = rec.cod_acct_no
                        AND flg_mnt_status = 'A';

                EXCEPTION
                    WHEN no_data_found THEN
                        var_ctr_instal := 0;
                    WHEN OTHERS THEN
                        ora_raiserror(sqlcode, 'SELECT FAILED FROM ln_acct_dtls FOR VAR_CTR_INSTAL   : ' || rec.cod_acct_no, $$plsql_line);
                        RETURN 95;
                END;

                BEGIN
                    SELECT
                        nvl(SUM(amt_arrears_due),--20 MAR Change
                         0) -- Principal Overdue
                    INTO var_l_overdue_prin
                    FROM
                        ln_arrears_table
                    WHERE
               --DAT_ARREAR_CANCELLED = '01-JAN-1800'
                        cod_arrear_type IN ( 'C' )
                        AND cod_acct_no = rec.cod_acct_no
                        AND dat_arrears_assessed > (
                            SELECT
                                MIN(dat_stage_start)
                            FROM
                                ln_acct_schedule
                            WHERE
                                    cod_acct_no = rec.cod_acct_no
                                AND flg_mnt_status = 'A'
                                AND cod_instal_rule IN (
                                    SELECT
                                        cod_inst_rule
                                    FROM
                                        ln_inst_rules
                                    WHERE
                                        cod_inst_calc_method IN ( 'EMI', 'EPI' )
                                        AND flg_mnt_status = 'A'
                                )
                        );

                EXCEPTION
                    WHEN no_data_found THEN
                        var_l_overdue_prin := 0;
                    WHEN OTHERS THEN
                        ora_raiserror(sqlcode, 'SELECT FAILED FROM ln_arrears_table FOR var_l_overdue_prin   : ' || rec.cod_acct_no, $$plsql_line);
                        RETURN 95;
                END;

                BEGIN
                    SELECT
                        nvl(SUM(amt_arrears_due), 0) -- Interest Overdue
                    INTO var_l_overdue_interest
                    FROM
                        ln_arrears_table
                    WHERE
               --DAT_ARREAR_CANCELLED = '01-JAN-1800'
                        cod_arrear_type IN ( 'I', 'N' )
                        AND cod_acct_no = rec.cod_acct_no
                        AND dat_arrears_assessed > (
                            SELECT
                                MIN(dat_stage_start)
                            FROM
                                ln_acct_schedule
                            WHERE
                                    cod_acct_no = rec.cod_acct_no
                                AND flg_mnt_status = 'A'
                                AND cod_instal_rule IN (
                                    SELECT
                                        cod_inst_rule
                                    FROM
                                        ln_inst_rules
                                    WHERE
                                        cod_inst_calc_method IN ( 'EMI', 'EPI' )
                                        AND flg_mnt_status = 'A'
                                )
                        );

                EXCEPTION
                    WHEN no_data_found THEN
                        var_l_overdue_interest := 0;
                    WHEN OTHERS THEN
                        ora_raiserror(sqlcode, 'SELECT FAILED FROM ln_arrears_table FOR var_l_overdue_interest   : ' || rec.cod_acct_no,
                        $$plsql_line);
                        RETURN 95;
                END;

--                BEGIN  --pswani commented on 15-MAY-2024
--                    SELECT
--                        nvl(round(rat_int_current, 4), 0) -- LOAN  EFF  RATE --VAR_NET_EFFECT_RAT
--                    INTO var_net_effect_rat
--                    FROM
--                        ln_acct_state
--                    WHERE
--                        cod_acct_no = rec.cod_acct_no;
--
--                EXCEPTION
--                    WHEN no_data_found THEN
--                        var_net_effect_rat := 0;
--                    WHEN OTHERS THEN
--                        ora_raiserror(sqlcode, 'SELECT FAILED FROM ln_acct_state FOR var_net_effect_rat   : ' || rec.cod_acct_no,
--                        $$plsql_line);
--                        RETURN 95;
--                END;
--
--                IF ( var_net_effect_rat = 0 ) THEN
--                    BEGIN
--                        SELECT
--                            rat_int_slab
--                        INTO var_net_effect_rat
--                        FROM
--                            ln_acct_rates_detl
--                        WHERE
--                                cod_acct_no = rec.cod_acct_no
--                            AND ctr_from_dat_slab = (
--                                SELECT
--                                    MAX(ctr_from_dat_slab)
--                                FROM
--                                    ln_acct_rates_detl
--                                WHERE
--                                        cod_acct_no = rec.cod_acct_no
--                                    AND ctr_int_srl = 0
--                                    AND ctr_from_dat_slab < '01-Jan-2099'
--                            )
--                            AND ctr_amd_no = (
--                                SELECT
--                                    MAX(ctr_amd_no)
--                                FROM
--                                    ln_acct_rates_detl
--                                WHERE
--                                        cod_acct_no = rec.cod_acct_no
--                                    AND ctr_int_srl = 0
--                                    AND ctr_from_dat_slab < '01-Jan-2099'
--                            )
--                            AND ctr_int_srl = 0
--                            AND ctr_from_dat_slab < '01-Jan-2099';
--
--                    EXCEPTION
--                        WHEN no_data_found THEN
--                            var_net_effect_rat := 0;
--                        WHEN OTHERS THEN
--                            ora_raiserror(sqlcode, 'SELECT FAILED FROM ln_acct_rates_detl FOR var_net_effect_rat   : ' || rec.cod_acct_no,
--                            $$plsql_line);
--                            RETURN 95;
--                    END;
--                END IF;
            BEGIN
                SELECT
				nvl(NET_RATE ,0)      
             INTO   var_net_effect_rat   --pswani 15-MAY-2024 , taken query from LNM10.
            FROM
                ln_acct_pricing_rate_detl
            WHERE
                    cod_acct_no = rec.cod_acct_no
                AND ctr_amd_no = (
                    SELECT
                        MAX(ctr_amd_no)
                    FROM
                        ln_acct_pricing_rate_detl
                    WHERE
                        cod_acct_no = rec.cod_acct_no
                )
                AND dat_from = (
                    SELECT
                        MAX(dat_from)
                    FROM
                        ln_acct_pricing_rate_detl
                    WHERE
                            cod_acct_no = rec.cod_acct_no
                        AND dat_from < pk_ba_global.dat_process);

                 EXCEPTION
                        WHEN no_data_found THEN
                            var_net_effect_rat := 0;
                        WHEN OTHERS THEN
                            ora_raiserror(sqlcode, 'SELECT FAILED FROM ln_acct_pricing_rate_detl FOR var_net_effect_rat   : ' || rec.cod_acct_no,
                            $$plsql_line);
                            RETURN 95;
                END;
        -- FIND THE LAST INSTALLMENT FULLY PAID BY CLIENT
                BEGIN
                    SELECT
                        nvl(SUM(cnt_emis), 0)
                    INTO var_ctr_received_instal
                    FROM
                        (
                            SELECT
                                SUM(amt_arrears_assessed - amt_arrears_due),
                                SUM(amt_arrears_assessed),
                                dat_arrears_assessed,
                                round(SUM(amt_arrears_assessed - amt_arrears_due) / SUM(amt_arrears_assessed), 2) cnt_emis,
                                COUNT(1)
                            FROM
                                ln_arrears_table
                            WHERE
                                    cod_acct_no = rec.cod_acct_no
                                AND cod_arrear_type IN ( 'C' )
                            GROUP BY
                                dat_arrears_assessed
                        );

                EXCEPTION
                    WHEN no_data_found THEN
                        var_l_ctr_instal_null := 0;
                        var_ctr_received_instal := 0.0;
                    WHEN OTHERS THEN
                        ora_raiserror(sqlcode, 'SELECT FAILED FROM LN_ARREARS_TABLE FOR var_ctr_received_instal   : ' || rec.cod_acct_no,
                        $$plsql_line);
                        RETURN 95;
                END;

                BEGIN
                    SELECT
                        txt_spouse_name
                    INTO var_nam_cust_spouse
                    FROM
                        ci_custmast_ext
                    WHERE
                            cod_cust_id = rec.cod_cust_id
                        AND flg_mnt_status = 'A';

                EXCEPTION
                    WHEN no_data_found THEN
                        var_nam_cust_spouse := NULL;
                    WHEN OTHERS THEN
                        ora_raiserror(sqlcode, 'SELECT FAILED FROM ci_custmast_ext FOR VAR_NAM_CUST_SPOUSE   : ' || rec.cod_acct_no, $$plsql_line);
                END;

                IF ( var_nam_cust_spouse IS NULL ) THEN
                    BEGIN
                        SELECT
                            txt_father_name
                        INTO var_nam_cust_spouse
                        FROM
                            ci_custmast_ext
                        WHERE
                                cod_cust_id = rec.cod_cust_id
                            AND flg_mnt_status = 'A';

                    EXCEPTION
                        WHEN no_data_found THEN
                            var_nam_cust_spouse := NULL;
                        WHEN OTHERS THEN
                            ora_raiserror(sqlcode, 'SELECT FAILED FROM ci_custmast_ext FOR VAR_NAM_CUST_SPOUSE   : ' || rec.cod_acct_no,
                            $$plsql_line);
                    END;
                END IF;

                BEGIN
                    SELECT
                        nvl(SUM(amt_arrears_due), 0)
                                     -- TOTAL_DUE --VAR_TOTAL_DUE
                    INTO var_total_due  
                    FROM
                        ln_arrears_table
                    WHERE
               --DAT_ARREAR_CANCELLED = '01-JAN-1800'
                        cod_arrear_type IN ( 'I', 'N', 'C' )
                        AND cod_acct_no = rec.cod_acct_no
--                        AND dat_arrears_assessed > (
--                            SELECT
--                                MIN(dat_stage_start)
--                            FROM
--                                ln_acct_schedule
--                            WHERE
--                                    cod_acct_no = rec.cod_acct_no
--                                AND flg_mnt_status = 'A'
--                                AND cod_instal_rule IN (
--                                    SELECT
--                                        cod_inst_rule
--                                    FROM
--                                        ln_inst_rules
--                                    WHERE
--                                        cod_inst_calc_method IN ( 'EMI', 'EPI' )
--                                        AND flg_mnt_status = 'A'
--                                )
--                        );
;
                EXCEPTION
                    WHEN no_data_found THEN
                        var_total_due := 0;
                    WHEN OTHERS THEN
                        ora_raiserror(sqlcode, 'SELECT FAILED FROM ln_arrears_table FOR var_total_due   : ' || rec.cod_acct_no, $$plsql_line);
                END;

--                BEGIN --commented on 06 MAY 2024 pswani , no need for pre emi due.
--                    SELECT
--                        SUM(amt_arrears_due)
--                                     -- TOTAL_DUE --VAR_TOTAL_DUE
--                    INTO var_total_due_1
--                    FROM
--                        ln_arrears_table
--                    WHERE
--                        cod_arrear_type IN ( 'I', 'N', 'C' )
--                        AND cod_acct_no = rec.cod_acct_no;
--
--                EXCEPTION
--                    WHEN no_data_found THEN
--                        var_total_due_1 := 0;
--                    WHEN OTHERS THEN
--                        ora_raiserror(sqlcode, 'SELECT FAILED FROM ln_arrears_table FOR var_total_due_1   : ' || rec.cod_acct_no, $$plsql_line);
--                END;

--                IF ( var_total_due = 0 ) THEN
--                    var_total_due := var_total_due_1;
--                END IF;
                IF ( rec.dat_of_maturity_d < var_l_dat_process ) THEN
                    var_dat_next_due := '01-JAN-1800';
                ELSE
                    BEGIN
                        SELECT
                            dat_next_due -- CURRENT_MONTH_INSTLAMENT_DUE_DATE --VAR_DAT_NEXT_DUE
                        INTO var_dat_next_due
                        FROM
                            ln_acct_state
                        WHERE
                            cod_acct_no = rec.cod_acct_no;

                    EXCEPTION
                        WHEN no_data_found THEN
                            var_dat_next_due := NULL;
                        WHEN OTHERS THEN
                            ora_raiserror(sqlcode, 'SELECT FAILED FROM ln_acct_state FOR VAR_DAT_NEXT_DUE   : ' || rec.cod_acct_no, $$plsql_line);
                    END;
                END IF;

                BEGIN
                    SELECT
                        round(SUM(amt_arrears_due) / SUM(amt_arrears_assessed), 2)
                    INTO var_l_amt_arrears_due_assessed   -- OVERDUE_INSTL_COUNT 
                    FROM
                        ln_arrears_table
                    WHERE
                            cod_acct_no = rec.cod_acct_no
                        AND amt_arrears_due > 0
                        AND cod_arrear_type IN ( 'C', 'I', 'N' )
                        AND dat_arrears_assessed < var_l_dat_process
                        AND dat_arrears_due > (
                            SELECT
                                MIN(dat_stage_start)
                            FROM
                                ln_acct_schedule
                            WHERE
                                    cod_acct_no = rec.cod_acct_no
                                AND flg_mnt_status = 'A'
                                AND cod_instal_rule IN (
                                    SELECT
                                        cod_inst_rule
                                    FROM
                                        ln_inst_rules
                                    WHERE
                                        cod_inst_calc_method IN ( 'EMI', 'EPI' )
                                        AND flg_mnt_status = 'A'
                                )
                        );

                EXCEPTION
                    WHEN no_data_found THEN
                        var_l_amt_arrears_due_assessed := 0;
                    WHEN OTHERS THEN
                        ora_raiserror(sqlcode, 'SELECT FAILED FROM ln_arrears_table FOR VAR_l_AMT_ARREARS_DUE_ASSESSED   : ' || rec.cod_acct_no,
                        $$plsql_line);
                END;

                BEGIN
                    SELECT
                        COUNT(*)
                    INTO var_l_arrears_count
                    FROM
                        ln_arrears_table
                    WHERE
                            cod_acct_no = rec.cod_acct_no
                        AND amt_arrears_due > 0
                        AND cod_arrear_type IN ( 'C' );

                EXCEPTION
                    WHEN no_data_found THEN
                        var_l_arrears_count := 0;
                    WHEN OTHERS THEN
                        ora_raiserror(sqlcode, 'SELECT FAILED FROM ln_arrears_table FOR VAR_L_ARREARS_COUNT   : ' || rec.cod_acct_no,
                        $$plsql_line);
                END;

                var_ctr_overdue_instal := var_l_arrears_count * var_l_amt_arrears_due_assessed;
                
               BEGIN
                    SELECT-- LAST_RECEIVED_DATE/KNOCKOFF  DATE  --VAR_DAT_LAST_PAYMENT,
                                MAX(dat_value)  --20 MARCH CHANGE
                        INTO VAR_DAT_LAST_PAYMENT
                            FROM
                                ln_nobook_ext l
                            WHERE
                                    l.cod_acct_no = rec.cod_acct_no
                                AND flg_cust_soa = 'Y'
                                AND flg_drcr = 'C';

                EXCEPTION
                    WHEN no_data_found THEN
                        VAR_DAT_LAST_PAYMENT := NULL;
                    WHEN OTHERS THEN
                        ora_raiserror(sqlcode, 'SELECT FAILED FROM ln_nobook_ext FOR VAR_DAT_LAST_PAYMENT   : ' || rec.cod_acct_no,
                        $$plsql_line);
                END;
                
                BEGIN
                    SELECT --LAST_RECEIPT_AMOUNT --VAR_AMT_ARREARS_ASSESSED,
                                nvl(SUM(amt_txn_acy), 0)
                            INTO VAR_L_LAST_RECEIPT_AMOUNT
                            FROM
                                ln_nobook_ext l
                            WHERE
                                    l.cod_acct_no = rec.cod_acct_no
                                AND flg_cust_soa = 'Y'
                                AND dat_value = VAR_DAT_LAST_PAYMENT
                                AND flg_drcr = 'C';

                EXCEPTION
                    WHEN no_data_found THEN
                        VAR_L_LAST_RECEIPT_AMOUNT := 0;
                    WHEN OTHERS THEN
                        ora_raiserror(sqlcode, 'SELECT FAILED FROM ln_nobook_ext FOR VAR_L_LAST_RECEIPT_AMOUNT   : ' || rec.cod_acct_no,
                        $$plsql_line);
                END;
                
                
                BEGIN
                    INSERT INTO temp_ln_x_duelistcom_ext (
                        session_id,
                        old_loan_no,
                        cod_acct_no,
                        nam_cc_state,
                        region,
                        nam_branch,
                        txt_scheme,
                        nam_cust_shrt,
                        nam_cust_spouse,
                        ctr_instal,
                        loan_advance_instl,
                        ctr_instal_no,
                        ctr_received_instal,
                        ctr_overdue_instal,
                        ctr_overdue_pre_emi_instal,
                        total_due,
                        amt_lpp_arrears_due,
                        amt_pre_emi,
                        amt_cbb,
                        amt_other,
                        amt_princ_balance,
                        max_dpd,
                        amt_next_due,
                        dat_next_due,
                        amt_face_value,
                        dat_last_payment,
                        amt_arrears_assessed,
                        dat_first_disb,
                        dat_stage_start,
                        dat_stage_end,
                        repo_flag,
                        amt_arrears_princ,
                        amt_overdue_interest,
                        emi_pattern,
                        frq_instal,
                        amt_presentation,
                        ctr_chq_in_transit,
                        disb_status,
                        txt_acct_status,
                        nam_prod,
                        net_effect_rat
                    ) VALUES (
                        var_l_session_id,
                        (
                            SELECT
                                cod_acct_no_old
                            FROM
                                ln_x_old_new_acct_xref lnx
                            WHERE
                                    lnx.cod_acct_no_new = rec.cod_acct_no
                                AND lnx.flg_mnt_status = 'A'
                        ),
                        rec.cod_acct_no,
                        replace(rec.nam_cc_state, ',', ' '), --VAR_STATE
                        replace(rec.nam_cc_city, ',', ' '), --REGION
                        replace(rec.nam_branch, ',', ' '),
                        (
                            SELECT --VAR_TXT_SCHEME
                                decode(txt_scheme, 'G', 'GENERAL', 'S', 'STS',
                                       'EL', 'Employee Loan') --SCHEME
                            FROM
                                ln_x_addln_attributes lnaddattr
                            WHERE
                                    lnaddattr.cod_acct_no = rec.cod_acct_no
                                AND lnaddattr.flg_mnt_status = 'A'
                        ),
                        replace(rec.nam_cust_shrt, ',', ' '),
                        replace(var_nam_cust_spouse, ',', ' '), --VAR_NAM_CUST_SPOUSE                
                        var_ctr_instal,
                        (
                            SELECT
                                COUNT(*)
                            FROM
                                ln_acct_schedule_detls
                            WHERE
                                    cod_acct_no = rec.cod_acct_no
                                AND amt_instal_outst = '0'
                        ), --VAR_LOAN_ADVANCE_INSTL

                        (
                            SELECT
                                COUNT(*)
              -- TOTAL_BILLED_INSTL_NO  --VAR_CTR_INSTAL_NO,
                            FROM
                                ln_arrears_table
                            WHERE
                                    cod_acct_no = rec.cod_acct_no
                                AND cod_arrear_type = 'C'
                        ),
                        var_ctr_received_instal,
                        var_ctr_overdue_instal,
                        (
                            SELECT
                                COUNT(*)  --OVERDUE PRE EMI COUNT --VAR_CTR_OVERDUE_PRE_EMI_INSTAL
                            FROM
                                ln_arrears_table
                            WHERE
                                    cod_acct_no = rec.cod_acct_no
                                AND amt_arrears_due > 0
                                AND cod_arrear_type IN ( 'I', 'N' )
                                AND dat_arrears_assessed <= (
                                    SELECT
                                        MAX(dat_stage_end)
                                    FROM
                                        ln_acct_schedule
                                    WHERE
                                            cod_acct_no = rec.cod_acct_no
                                        AND flg_mnt_status = 'A'
                                        AND cod_instal_rule IN (
                                            SELECT
                                                cod_inst_rule
                                            FROM
                                                ln_inst_rules
                                            WHERE
                                                cod_inst_calc_method IN ( 'IOI' )
                                                AND flg_mnt_status = 'A'
                                        )
                                )
                        ),
                        nvl(var_total_due, 0),
                        (
                            SELECT
                                nvl(SUM(amt_arrears_due), 0) -- LPP --VAR_AMT_LPP_ARREARS_DUE
                            FROM
                                ln_arrears_table
                            WHERE
                                    dat_arrear_cancelled = '01-JAN-1800'
                                AND cod_arrear_type IN ( 'L', 'A' )
                                AND cod_acct_no = rec.cod_acct_no
                        ),
                        (
                            SELECT
                                nvl(SUM(amt_arrears_due), 0) -- PRE_EMI  --VAR_AMT_PRE_EMI
                            FROM
                                ln_arrears_table
                            WHERE
                                    cod_acct_no = rec.cod_acct_no
                                AND cod_arrear_type IN ( 'I', 'N' )
                                AND dat_arrears_assessed <= (
                                    SELECT
                                        MAX(dat_stage_end)
                                    FROM
                                        ln_acct_schedule
                                    WHERE
                                            cod_acct_no = rec.cod_acct_no
                                        AND flg_mnt_status = 'A'
                                        AND cod_instal_rule IN (
                                            SELECT
                                                cod_inst_rule
                                            FROM
                                                ln_inst_rules
                                            WHERE
                                                cod_inst_calc_method IN ( 'IOI' )
                                                AND flg_mnt_status = 'A'
                                        )
                                )
                        ),
                        (
                            SELECT
                                nvl(SUM(amt_arrears_due), 0) -- CBC_DUE --VAR_AMT_CBB,
                            FROM
                                ln_arrears_table
                            WHERE
                                    dat_arrear_cancelled = '01-JAN-1800'
                                AND cod_arrear_charge IN ( 110, 1110, 259 )
                                AND cod_acct_no = rec.cod_acct_no
                        ),
                        (
                            SELECT
                                nvl(SUM(amt_arrears_due), 0) -- OTHER_CHARGES_DUE  --VAR_AMT_OTHER
                            FROM
                                ln_arrears_table
                            WHERE
                                    dat_arrear_cancelled = '01-jan-1800'
                                AND cod_arrear_type IN ( 'F', 'D' )
                                AND cod_acct_no = rec.cod_acct_no
                                AND cod_arrear_charge NOT IN ( 110, 1110, 259 )
                        ),
                        (
                            SELECT
                                nvl(amt_princ_balance, 0) --TOTAL_POS --REC.AMT_PRINC_BALANCE,
                            FROM
                                ln_acct_balances
                            WHERE
                                cod_acct_no = rec.cod_acct_no
                        ),
                        (
                            SELECT
                                max_dpd --DPD
                            FROM
                                ac_acct_crr_code
                            WHERE
                                    cod_acct_no = rec.cod_acct_no
                                AND flg_mnt_status = 'A'
                        ),

             --REC.MAX_DPD,
                        (
                            SELECT
                                nvl(amt_next_due, 0) -- CURRENT_MONTH_INSTLAMENT --VAR_AMT_NEXT_DUE
                            FROM
                                ln_acct_state
                            WHERE
                                cod_acct_no = rec.cod_acct_no
                        ),
                        var_dat_next_due,
                        rec.amt_face_value,
--                        (
--                            SELECT -- LAST_RECEIVED_DATE/KNOCKOFF  DATE  --VAR_DAT_LAST_PAYMENT,
--                                MAX(dat_last_payment) 
--                            FROM 
--                                ln_arrears_table lnarr
--                            WHERE
--                                    cod_acct_no = rec.cod_acct_no
----                                AND ( lnarr.cod_acct_no, lnarr.dat_last_payment ) IN (
----                                    SELECT
----                                        cod_acct_no, MAX(dat_last_payment)
----                                    FROM
----                                        ln_arrears_table lnarr
----                                    GROUP BY
----                                        cod_acct_no
----                                )
--                                AND dat_last_payment NOT IN ( '01-JAN-1950' )
--                                AND cod_arrear_type IN ( 'I', 'N', 'C' )
--                            GROUP BY
--                                cod_acct_no
--                        ),
--                        (
--                            SELECT-- LAST_RECEIVED_DATE/KNOCKOFF  DATE  --VAR_DAT_LAST_PAYMENT,
--                                MAX(dat_value)  --20 MARCH CHANGE
--                            FROM
--                                ln_nobook_ext l
--                            WHERE
--                                    l.cod_acct_no = rec.cod_acct_no
--                                AND flg_cust_soa = 'Y'
--                                AND flg_drcr = 'C'
--                        ),
                        VAR_DAT_LAST_PAYMENT,
--                        (
--                            SELECT --LAST_RECEIPT_AMOUNT --VAR_AMT_ARREARS_ASSESSED,
--                                nvl(SUM(amt_txn_acy), 0)
--                            FROM
--                                ln_nobook_ext l
--                            WHERE
--                                    l.cod_acct_no = rec.cod_acct_no
--                                AND flg_cust_soa = 'Y'
--                                AND dat_value IN (
--                                    SELECT
--                                        MAX(dat_value)
--                                    FROM
--                                        ln_nobook_ext
--                                    WHERE
--                                            cod_acct_no = l.cod_acct_no
--                                        AND flg_drcr = 'C'
--                                )
--                                AND flg_drcr = 'C'
--                        ),
                        VAR_L_LAST_RECEIPT_AMOUNT,
                        rec.dat_first_disb, --VAR_DAT_FIRST_DISB
                        (
                            SELECT
                                MIN(dat_first_instal) -- First_Emi_Date --VAR_DAT_STAGE_START,
                            FROM
                                ln_acct_schedule
                            WHERE
                                    cod_acct_no = rec.cod_acct_no
                                AND flg_mnt_status = 'A'
                                AND cod_instal_rule IN (
                                    SELECT
                                        cod_inst_rule
                                    FROM
                                        ln_inst_rules
                                    WHERE
                                        cod_inst_calc_method IN ( 'EPI', 'EMI' )
                                        AND flg_mnt_status = 'A'
                                )
                        ),
                        (
                            SELECT
                                MAX(dat_stage_end) -- Last_Emi_Date --VAR_DAT_STAGE_END,
                            FROM
                                ln_acct_schedule
                            WHERE
                                    cod_acct_no = rec.cod_acct_no
                                AND flg_mnt_status = 'A'
                                AND cod_instal_rule IN (
                                    SELECT
                                        cod_inst_rule
                                    FROM
                                        ln_inst_rules
                                    WHERE
                                        cod_inst_calc_method IN ( 'EPI', 'EMI' )
                                        AND flg_mnt_status = 'A'
                                )
                        ),
                        NULL, --VAR_REPO_FLAG
                        nvl(var_l_overdue_prin, 0), -- OVERDUE_PRIN  --VAR_AMT_ARREARS_PRINC,
                        nvl(var_l_overdue_interest, 0), -- OVERDUE_INTEREST  --VAR_AMT_OVERDUE_INTEREST,
                        'EPI', --VAR_EMI_PATTERN
                        (
                            SELECT
                                decode(MAX(frq_instal), 65536, 'YEARLY', 0, NULL) --EMI FREQUENCY --VAR_FRQ_INSTAL,
                            FROM
                                ln_acct_schedule lnsch
                            WHERE
                                    lnsch.cod_acct_no = rec.cod_acct_no
                                AND lnsch.flg_mnt_status = 'A'
                                AND cod_instal_rule IN (
                                    SELECT
                                        cod_inst_rule
                                    FROM
                                        ln_inst_rules
                                    WHERE
                                        cod_inst_calc_method IN ( 'EPI', 'EMI' )
                                )
                        ),
                        (
                            SELECT
                                nvl(SUM(amt_presentation), 0) --CHEQUE_IN_TRANSIT_AMT --VAR_AMT_PRESENTATION,
                            FROM
                                ln_x_repay_register lnxrepay
                            WHERE
                                    lnxrepay.cod_acct_no = rec.cod_acct_no
                                AND flg_repay_status = 'U'
                                AND flg_mnt_status = 'A'
                                AND cod_repay_mode IN ( 'MNACH', 'MECS', 'IDD', 'ICHQ', 'DEBIT' )
                        ),
                        (
                            SELECT
                                COUNT(cod_acct_no) --CHEQUE_IN_TRANSIT_COUNT --VAR_CTR_CHQ_IN_TRANSIT,
                            FROM
                                ln_x_repay_register lnxrepay
                            WHERE
                                    lnxrepay.cod_acct_no = rec.cod_acct_no
                                AND flg_repay_status = 'U'
                                AND flg_mnt_status = 'A'
                                AND cod_repay_mode IN ( 'MNACH', 'MECS', 'IDD', 'ICHQ', 'DEBIT' )
                        ),
                       -- decode(rec.disb_status, 'F', 'FULLY DISBURSED', 'PARTIALLY DISBURSED'),
                        ap_ln_x_get_disb_status(rec.cod_acct_no),
                        (
                            SELECT
                                bacctstat.txt_acct_status -- LOAN_STATUS --VAR_TXT_ACCT_STATUS
                            FROM
                                ba_acct_status bacctstat
                            WHERE
                                    cod_module = 'LN'
                                AND bacctstat.cod_acct_status = rec.cod_acct_stat
                        ),
                        (
                            SELECT
                                nam_product --PRODUCT NAME --VAR_NAM_PROD
                            FROM
                                ln_prod_mast lpm
                            WHERE
                                    lpm.cod_prod = rec.cod_prod
                                AND flg_mnt_status = 'A'
                        ),
                        round(var_net_effect_rat, 4)
                    );

                EXCEPTION
                    WHEN OTHERS THEN
                        ora_raiserror(sqlcode, 'INSERT FAILED TEMP_LN_X_DUELISTCOM_EXT', $$plsql_line);
                        RETURN 95;
                END;

            END LOOP;
        END;

        BEGIN
            OPEN cursname FOR SELECT
                                  'Loan_ID'                           loanid_h,
                                  'Loan_No'                           loanno_h,
                                  'State'                             state_h,
                                  'Region'                            region_h,
                                  'Loan_Branch'                       loanbranch_h,
                                  'Scheme'                            scheme_h,
                                  'Customer_Name'                     customername_h,
                                  'Father_Husband_Name'               fatherhusbandname_h,
                                  'Total_No_of_Instl'                 totalnoofinstl_h,
                                  'Moratorium'                        loanadvanceinstl_h,
                                  'Total_Billed_Instl_No'             totalbilledinstlno_h,
                                  'Total_Receiv_Instl'                totalreceivinstl_h,
                                  'Overdue_Instl_Count'               overdueinstlcount_h,
                                  'Overdue_Pre_EMI_count'             overduepreemicount_h,
                                  'Total_Due'                         totaldue_h,
                                  'LPP'                               lpp_h,
                                  'PRE_EMI'                           preemi_h,
                                  'CBC_DUE'                           cbcdue_h,
                                  'OTHER_CHARGES_DUE'                 otherchargesdue_h,
                                  'TOTAL_POS'                         totalpos_h,
                                  'DPD'                               dpd_h,
                                  'CURRENT_MONTH_INSTLAMENT'          currentmonthinstlmnt_h,
                                  'CURRENT_MONTH_INSTLAMENT_DUE_DATE' currentmonthinstlmntdate_h,
                                  'LOAN_AMOUNT'                       loanamount_h,
                                  'LAST_RECEIVED_DATE/KNOCKOFF DATE'  lastrecvdate_h,
                                  'LAST_RECEIPT_AMOUNT'               lastreceiptamt_h,
                                  'BOOKING_DATE'                      bookingdate_h,
                                  'FIRST_EMI_DATE'                    firstemidate_h,
                                  'LAST_EMI_DATE'                     lastemidate_h,
                                  'REPO_FLAG'                         repoflag_h,
                                  'OVERDUE_PRIN'                      overdueprin_h,
                                  'OVERDUE_INTEREST'                  overdueinterest_h,
                                  'EMI_PATTERN'                       emipattern_h,
                                  'EMI_FREQUENCY'                     emifrequency_h,
                                  'CHEQUE_IN_TRANSIT_AMT'             chequeintransitamt_h,
                                  'CHEQUE_IN_TRANSIT_COUNT'           chequeintransitcount_h,
                                  'DISBURSAL_STATUS'                  disbursalstatus_h,
                                  'LOAN_STATUS'                       loanstatus_h,
                                  'LOAN_PRODUCT'                      loanproduct_h,
                                  'LOAN EFF RATE'                     loaneffrate_h,
                                  old_loan_no                         loanid_d,
                                  cod_acct_no                         loanno_d,
                                  nam_cc_state                        state_d,
                                  region                              region_d,
                                  nam_branch                          loanbranch_d,
                                  txt_scheme                          scheme_d,
                                  nam_cust_shrt                       customername_d,
                                  nam_cust_spouse                     fatherhusbandname_d,
                                  ctr_instal                          totalnoofinstl_d,
                                  loan_advance_instl                  loanadvanceinstl_d,
                                  ctr_instal_no                       totalbilledinstlno_d,
                                  ctr_received_instal                 totalreceivinstl_d,
                                  ctr_overdue_instal                  overdueinstlcount_d,
                                  ctr_overdue_pre_emi_instal          overduepreemicount_d,
                                  total_due                           totaldue_d,
                                  amt_lpp_arrears_due                 lpp_d,
                                  amt_pre_emi                         preemi_d,
                                  amt_cbb                             cbcdue_d,
                                  amt_other                           amt_otherchargesdue_d,
                                  amt_princ_balance                   totalpos_d,
                                  max_dpd                             dpd_d,
                                  amt_next_due                        currentmonthinstlmnt_d,
                                  dat_next_due                        currentmonthinstlmntdate_d,
                                  amt_face_value                      loanamount_d,
                                  dat_last_payment                    lastrecvdate_d,
                                  amt_arrears_assessed                lastreceiptamt_d,
                                  dat_first_disb                      bookingdate_d,
                                  dat_stage_start                     firstemidate_d,
                                  dat_stage_end                       lastemidate_d,
                                  repo_flag                           repoflag_d,
                                  amt_arrears_princ                   overdueprin_d,
                                  amt_overdue_interest                overdueinterest_d,
                                  emi_pattern                         emipattern_d,
                                  frq_instal                          emifrequency_d,
                                  amt_presentation                    chequeintransitamt_d,
                                  ctr_chq_in_transit                  chequeintransitcount_d,
                                  disb_status                         disbursalstatus_d,
                                  txt_acct_status                     loanstatus_d,
                                  nam_prod                            loanproduct_d,
                                  net_effect_rat                      loaneffrate_d
                              FROM
                                  temp_ln_x_duelistcom_ext
                              WHERE
                                  session_id = var_l_session_id
                              ORDER BY
                                  cod_acct_no;

        EXCEPTION
            WHEN OTHERS THEN
                ora_raiserror(sqlcode, 'Open Cursor failed for Pk_Ext_DueListCom', $$plsql_line);
                RETURN 100;
        END;

        RETURN 0;
    END;

END;
